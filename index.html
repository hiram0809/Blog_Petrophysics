<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gráfico de Pickett Interactivo</title>
    <!-- Incluir la librería de Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #grafico {
            width: 100%;
            height: 600px;
        }
        #controles {
            margin-bottom: 20px;
        }
        .input-group {
            margin-bottom: 10px;
        }
        label {
            width: 150px;
            display: inline-block;
        }
        input[type="number"] {
            width: 100px;
        }
    </style>
</head>
<body>

    <h1>Gráfico de Pickett Interactivo</h1>

    <div id="controles">
        <div class="input-group">
            <label for="archivo">Cargar archivo CSV: </label>
            <input type="file" id="archivo" accept=".csv">
        </div>

        <div class="input-group">
            <label for="rw">Valor de Rw: </label>
            <input type="number" id="rw" name="rw" step="any" value="0.1">
        </div>

        <div class="input-group">
            <label for="m">Valor de m (Cementación): </label>
            <input type="number" id="m" name="m" step="any" value="2">
        </div>

        <div class="input-group">
            <label for="n">Valor de n (Saturación): </label>
            <input type="number" id="n" name="n" step="any" value="2">
        </div>
    </div>

    <div id="grafico"></div>

    <script>
        let datos = [];

        // Event listeners
        document.getElementById('archivo').addEventListener('change', function(e) {
            const archivo = e.target.files[0];
            if (!archivo) {
                return;
            }
            const lector = new FileReader();
            lector.onload = function(e) {
                const contenido = e.target.result;
                procesarDatos(contenido);
                actualizarGrafico();
            };
            lector.readAsText(archivo);
        });

        const inputs = ['rw', 'm', 'n'];
        inputs.forEach(id => {
            document.getElementById(id).addEventListener('input', function() {
                actualizarGrafico();
            });
        });

        function procesarDatos(csv) {
            const lineas = csv.split('\n');
            const encabezados = lineas[0].trim().split(',');

            // Identificar columnas de interés basadas en los mnemonics
            let indiceResistividad = -1;
            let indiceDensidad = -1;

            // Mnemonics comunes para resistividad y densidad
            const mnemonicsResistividad = ['RT', 'RES', 'ILD', 'LLD'];
            const mnemonicsDensidad = ['RHOB', 'DEN', 'DENS'];

            // Encontrar índices de las columnas
            encabezados.forEach((columna, indice) => {
                if (mnemonicsResistividad.includes(columna.trim().toUpperCase())) {
                    indiceResistividad = indice;
                }
                if (mnemonicsDensidad.includes(columna.trim().toUpperCase())) {
                    indiceDensidad = indice;
                }
            });

            if (indiceResistividad === -1 || indiceDensidad === -1) {
                alert('No se encontraron las columnas de resistividad y/o densidad en el archivo.');
                return;
            }

            datos = [];

            for (let i = 1; i < lineas.length; i++) {
                const linea = lineas[i].trim();
                if (linea === '') continue;

                const valores = linea.split(',');

                const resistividad = parseFloat(valores[indiceResistividad]);
                const densidad = parseFloat(valores[indiceDensidad]);

                if (isNaN(resistividad) || isNaN(densidad)) continue;

                // Calcular porosidad a partir de la densidad
                const porosidad = calcularPorosidadDensidad(densidad);

                datos.push({
                    porosidad: porosidad,
                    resistividad: resistividad
                });
            }
        }

        function calcularPorosidadDensidad(densidadMedida) {
            // Parámetros para arcilla y fluido agua
            const densidadMatriz = 2.65; // g/cm³ (típica para arenas)
            const densidadFluido = 1.0; // g/cm³ (agua)

            const porosidad = (densidadMatriz - densidadMedida) / (densidadMatriz - densidadFluido);

            return porosidad;
        }

        function actualizarGrafico() {
            if (datos.length === 0) {
                return;
            }

            const rw = parseFloat(document.getElementById('rw').value) || 0.1;
            const m = parseFloat(document.getElementById('m').value) || 2;
            const n = parseFloat(document.getElementById('n').value) || 2;

            const x = datos.map(d => d.porosidad);
            const y = datos.map(d => d.resistividad);

            const traceDatos = {
                x: x,
                y: y,
                mode: 'markers',
                type: 'scatter',
                name: 'Datos',
                marker: { size: 8, color: 'blue' }
            };

            // Generar línea de tendencia usando Rw, m, y n
            const xLinea = [];
            const yLinea = [];
            for (let phi = 0.01; phi <= 0.5; phi += 0.01) {
                const rt = (rw / (phi ** m));
                xLinea.push(phi);
                yLinea.push(rt);
            }

            const traceLinea = {
                x: xLinea,
                y: yLinea,
                mode: 'lines',
                type: 'scatter',
                name: `Rw = ${rw}, m = ${m}, n = ${n}`,
                line: { color: 'red' }
            };

            const layout = {
                xaxis: {
                    title: 'Porosidad (φ)',
                    type: 'log',
                    autorange: true
                },
                yaxis: {
                    title: 'Resistividad (Rt)',
                    type: 'log',
                    autorange: true
                },
                title: 'Gráfico de Pickett',
                showlegend: true
            };

            Plotly.newPlot('grafico', [traceDatos, traceLinea], layout);
        }
    </script>

</body>
</html>
